---
layout: post
title:  "JAVA开发工行H5支付接口"
date:   2020-04-14
categories: Project
tags: project note
---

* content
{:toc}

1. 开发工行H5支付接口






## SDK形式开发工行H5支付接口

### 写在前面
1. 这个H5支付接口前前后后写了很长时间,期间遇到种种问题,终于完成,先放个[工行开放文档H5支付接口](https://open.icbc.com.cn/icbc/apip/api_detail.html?apiId=10000000000000017001&baseUrl=%2Fb2c%2Fpay&resUrl=%2Ftransfer&version=V1&apiName=%E4%B8%AA%E4%BA%BA%E7%BA%BF%E4%B8%8A%E6%94%AF%E4%BB%98&serviceId=P0071&resourceId=10000000000000002721),这个一定要仔细看,很多错误可以直接在这里面找到答案
2. 还有一些错误就需要与工行对接人员沟通了,比如说测试服务器的时间,测试用的卡号,手机号,还有一些文档上说明不上传的参数,但是其实是必须上传的,不然是真报错啊,比如remark1

### 一、证书拆分
1. 因为我写的时候,用的是CA认证方式,所以工行会给我发一个,证书拆分工具,这个很简单,只需要按照指导文件,将`.pfx`文件的证书,拆分成`.crt`和`.key`后缀名的证书即可,然后用的时候需要以二进制的形式将文件进行base64编码即可
    ![证书拆分工具](/assets/拆分证书工具.png)

### 二、导入SDK
1. 因为我用的是工行的SDK,所以需要先导入[工行的sdk](https://open.icbc.com.cn/icbc/apip/docs_sdk&demo.html),可以在这个页面下载
2. 导入后找到你需要用的请求对象,首先清楚自己写的是什么接口,工行的接口分两种,一种是返回数据的,一种是返回页面的,而H5支付就是返回页面型的接口,请求对象名字一般是以接口名字命名的,比如我写的接口是`b2c/pay/transfer/V2`,我用的请求对象就是`B2CPayTransferRequestV2`
3. 具体的直接看下载sdk时附带的文档即可
    ![SDK文档](/assets/sdk文档.png)

### 三、补全参数
1. 最后一步就是要补全我们的参数,这是最容易错的地方,因为有很多错误,工行的开放文档是不写的,你找不到,只能找工行对接的人问
    1. 接口文档中所有是否必输的为`true`的参数,一个也不要少,马虎会让你浪费很长时间,如果有不知道填什么参数的项直接问工行对接人员
    2. 一定要注意每个参数字段的限制长度,比如good_id的长度为10,order_id的长度30
    3. 上送的参数一律不允许出现中文,所有中文参数,基本都要用`GBK编码`上传,这是在开放文档中没有的,比如`商品名称`这种参数
    4. 商户上送的订单不在有效范围内,这是最常见的错误,因为工行的测试服务器时间和正常的时间不一样,所以你需要询问工行对接的人员当前测试服务器的时间
    5. 订单有效期不正确,这是因为remark1字段没有上传的原因,因为文档上remark1字段不是必须上传的,但是我没上传会出现这个错误,所以其实这是个必须上传的参数
    6. 上传的域名时,测试时可以直接使用`localhost`,以后可以换成上传服务器ip
    7. 遇到问题及时和工行对接人员沟通

### 四、支付流程
1. 测试支付时需要工行对接人员提供测试用的手机号码和银行卡号

### 五、回调接口
1. 本地测试的时候可以使用`natapp`工具进行内网穿透,接受回调信息,很好用







